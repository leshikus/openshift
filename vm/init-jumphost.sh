#!/bin/sh

set -e
set -vx

subscribe() {
    sudo subscription-manager register --username committer --password $1
    sudo subscription-manager attach --auto
}

subscribe $1
wget https://developers.redhat.com/content-gateway/rest/mirror/pub/openshift-v4/clients/crc/latest/crc-linux-amd64.tar.xz
tar -xf crc-linux-amd64.tar.xz
echo y | crc-linux-2.24.1-amd64/crc setup

cat <<EOF >pull-secret.txt
{"auths":{"cloud.openshift.com":{"auth":"b3BlbnNoaWZ0LXJlbGVhc2UtZGV2K29jbV9hY2Nlc3NfYmU5OTMyYjJmYzEzNGMwODhkZjVjZTY1YTJkMzY0YzY6TjRWUFBIMDYxUlRIU0dQSTlHMzhSWURISzJTN1BDSlAxWkdKNVZBSk9XVU1TV0c0R05SM09VOVNWVVIzQjZFRw==","email":"alexei.fedotov@gmail.com"},"quay.io":{"auth":"b3BlbnNoaWZ0LXJlbGVhc2UtZGV2K29jbV9hY2Nlc3NfYmU5OTMyYjJmYzEzNGMwODhkZjVjZTY1YTJkMzY0YzY6TjRWUFBIMDYxUlRIU0dQSTlHMzhSWURISzJTN1BDSlAxWkdKNVZBSk9XVU1TV0c0R05SM09VOVNWVVIzQjZFRw==","email":"alexei.fedotov@gmail.com"},"registry.connect.redhat.com":{"auth":"fHVoYy1wb29sLWUxYWJlNjM0LWZhMjgtNDhkOC05ZTFkLWY0OTE2ZmU0MDVlYTpleUpoYkdjaU9pSlNVelV4TWlKOS5leUp6ZFdJaU9pSTJZV1JoTURjek9URTRZamcwTkRJMU9UVmlZakV3WVdWa01EZzVabU0xT0NKOS5DTVFpaWY3QjdiaG5jVkxHTVkxM3J5VE9aLTUzTUZ0Uy1kOFBZV3lWeEZzNkxpNVdmM1dDaGJodk1qQUppa09HMjgyM0hpX2xSY1FZdlg5Y1F5ZGlWVHZ5d0x5RjZIRlY3QVpkWklVSHhDd3pVaDl5SWF2eThwLVBGZW8wc1pJWmJla3JxSG4xcklvZEhIaVhuMmppMEdpTW8zV0d1eGlZWm5pcmFwMVFRQTY0eXpBamxweTdqWDc3YnlremhXZVByTkZ2WDFHWlZRNEJUN2tXb3g1bDlDZmpKWTBmRDB3UFB5QjItTkowRk81Rm9rOVV5eEt4aEpZVlRWNG9scnVzVTJZd0s1SERzVFhSd0luT1l1TUxpSkhaWWY2QnVyXy1VV2VCYWVRWDRaV3d4Zk42bC13YTRRYm4wUzY4MHlxbHRSemgyNlBoMi0tVTgzWHJ0UG5XZUNtUWhVaDhVZm5CbnViQ3hTU2kxSlR4V2J3cUc2YmxtZkxFRjNTV0lRMGgwcHhoMnRkSGtmNGQ4NndNcXduQzhHektodWJvZ2VDX1pEQWhLc0RmcmtycGNjcV9VYXVXaXNsX0xFNlMtSEVyRks4TDVmMmNyOGRQdnQ1bS1tMGJiakVxSDNxaVUxNWtaWWsxV1ByUW81QzNOanExTXdLR1o1TWRtRlZ1NlBzV2dXaXRoVk9wSElMSGJraWVjVUkwcUI1SV9pQlRSWEZBd2QyZUF5eW5jb25LaDVERDlaS1lJaTRDNFAxdFBub2FfVng5M3hoNTB0bVdJNDN4YmlsTzlOc2RjUXotNk1Pb0RUSFBGdEJXdWhMYnpDZTduMkNKUjFWZW9JdXpIYUUzcU1lSUFiNnBLZVlZMlREdTNIbXdjcVBnTW5CNkN6VkJvY2NlUllYNGZJaw==","email":"alexei.fedotov@gmail.com"},"registry.redhat.io":{"auth":"fHVoYy1wb29sLWUxYWJlNjM0LWZhMjgtNDhkOC05ZTFkLWY0OTE2ZmU0MDVlYTpleUpoYkdjaU9pSlNVelV4TWlKOS5leUp6ZFdJaU9pSTJZV1JoTURjek9URTRZamcwTkRJMU9UVmlZakV3WVdWa01EZzVabU0xT0NKOS5DTVFpaWY3QjdiaG5jVkxHTVkxM3J5VE9aLTUzTUZ0Uy1kOFBZV3lWeEZzNkxpNVdmM1dDaGJodk1qQUppa09HMjgyM0hpX2xSY1FZdlg5Y1F5ZGlWVHZ5d0x5RjZIRlY3QVpkWklVSHhDd3pVaDl5SWF2eThwLVBGZW8wc1pJWmJla3JxSG4xcklvZEhIaVhuMmppMEdpTW8zV0d1eGlZWm5pcmFwMVFRQTY0eXpBamxweTdqWDc3YnlremhXZVByTkZ2WDFHWlZRNEJUN2tXb3g1bDlDZmpKWTBmRDB3UFB5QjItTkowRk81Rm9rOVV5eEt4aEpZVlRWNG9scnVzVTJZd0s1SERzVFhSd0luT1l1TUxpSkhaWWY2QnVyXy1VV2VCYWVRWDRaV3d4Zk42bC13YTRRYm4wUzY4MHlxbHRSemgyNlBoMi0tVTgzWHJ0UG5XZUNtUWhVaDhVZm5CbnViQ3hTU2kxSlR4V2J3cUc2YmxtZkxFRjNTV0lRMGgwcHhoMnRkSGtmNGQ4NndNcXduQzhHektodWJvZ2VDX1pEQWhLc0RmcmtycGNjcV9VYXVXaXNsX0xFNlMtSEVyRks4TDVmMmNyOGRQdnQ1bS1tMGJiakVxSDNxaVUxNWtaWWsxV1ByUW81QzNOanExTXdLR1o1TWRtRlZ1NlBzV2dXaXRoVk9wSElMSGJraWVjVUkwcUI1SV9pQlRSWEZBd2QyZUF5eW5jb25LaDVERDlaS1lJaTRDNFAxdFBub2FfVng5M3hoNTB0bVdJNDN4YmlsTzlOc2RjUXotNk1Pb0RUSFBGdEJXdWhMYnpDZTduMkNKUjFWZW9JdXpIYUUzcU1lSUFiNnBLZVlZMlREdTNIbXdjcVBnTW5CNkN6VkJvY2NlUllYNGZJaw==","email":"alexei.fedotov@gmail.com"}}}
EOF

crc-linux-2.24.1-amd64/crc start -p pull-secret.txt

